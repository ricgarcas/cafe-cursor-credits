# Cafe Cursor - Project Rules

## Project Overview

Cafe Cursor is an event registration system for managing attendee registrations and distributing coupon codes via email. Single-city-per-deployment architecture with Luma event integration.

## Tech Stack

- Next.js 15 (App Router) with TypeScript
- Supabase (PostgreSQL) for database and authentication
- shadcn/ui components with Tailwind CSS v4
- Resend for email delivery
- Luma API for event integration
- Zod for schema validation

## Quick Commands

- `npm run dev` - Start development server (http://localhost:3000)
- `npm run build` - Production build
- `npm run lint` - Run ESLint
- `npx shadcn@latest add [component]` - Add shadcn/ui component

## Code Patterns

### Supabase Clients

Always use the correct client based on context:

```typescript
// User operations (respects RLS)
import { createClient } from '@/lib/supabase/server'
const supabase = await createClient()

// Admin operations (bypasses RLS)
import { createAdminClient } from '@/lib/supabase/server'
const supabase = await createAdminClient()

// Browser/Client Components
import { createClient } from '@/lib/supabase/client'
const supabase = createClient()
```

### Form Validation

Always use Zod for API input validation:

```typescript
import { z } from 'zod'

const schema = z.object({
  name: z.string().min(1).max(255),
  email: z.string().email().max(255),
})

const result = schema.safeParse(body)
if (!result.success) {
  return NextResponse.json({ error: 'Invalid input' }, { status: 400 })
}
```

### API Route Pattern

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createAdminClient } from '@/lib/supabase/server'
import { z } from 'zod'

export async function POST(request: NextRequest) {
  try {
    const body = await request.json()
    // Validate with Zod
    // Use createAdminClient() for privileged operations
    // Return NextResponse.json() with appropriate status
  } catch (error) {
    console.error('Error:', error)
    return NextResponse.json({ error: 'An error occurred' }, { status: 500 })
  }
}
```

### Component Styling

Use the `cn()` utility for conditional Tailwind classes:

```typescript
import { cn } from '@/lib/utils'

<div className={cn(
  "base-classes",
  condition && "conditional-classes"
)} />
```

### Sending Emails

API keys are stored in the database. Fetch settings and create a client:

```typescript
import { createAdminClient } from '@/lib/supabase/server'
import { createResendClient } from '@/lib/resend'
import { sendCouponEmail } from '@/lib/emails/send-coupon-email'

// Fetch API key from database
const supabase = await createAdminClient()
const { data: settings } = await supabase
  .from('app_settings')
  .select('resend_api_key, city_name')
  .limit(1)
  .single()

if (settings?.resend_api_key) {
  const resendClient = createResendClient(settings.resend_api_key)
  await sendCouponEmail({
    resendClient,
    attendee,
    couponCode,
    fromName: `Cafe Cursor ${settings.city_name}`,
  })
}
```

### Using Luma API

Luma API key is stored in the database. Fetch settings and create a service:

```typescript
import { createAdminClient } from '@/lib/supabase/server'
import { createLumaService } from '@/lib/luma/service'

// Fetch API key from database
const supabase = await createAdminClient()
const { data: settings } = await supabase
  .from('app_settings')
  .select('luma_api_key')
  .limit(1)
  .single()

if (settings?.luma_api_key) {
  const luma = createLumaService(settings.luma_api_key)
  const result = await luma.testConnection()
  const guests = await luma.getAllEventGuests(eventId, 'confirmed')
}
```

For syncing guests (handles everything including emails):

```typescript
import { syncLumaGuests } from '@/lib/luma/sync'

// Syncs guests from configured event, assigns coupons, sends emails
const result = await syncLumaGuests(eventId, {
  assignCoupons: true,
  sendEmails: true,
  status: 'confirmed',
})
```

## File Organization

- `src/app/` - Next.js App Router pages and API routes
- `src/app/api/` - API route handlers
- `src/app/admin/` - Protected admin pages
- `src/components/ui/` - shadcn/ui components (don't modify directly)
- `src/components/admin/` - Admin-specific components
- `src/lib/` - Utilities, clients, and services
- `src/lib/supabase/` - Supabase client configurations
- `src/lib/luma/` - Luma API integration
- `src/lib/emails/` - Email templates and sending logic
- `src/types/` - TypeScript type definitions

## Database Tables

- `attendees` - Registration records with coupon assignments
- `coupon_codes` - Coupon inventory and usage tracking
- `app_settings` - City configuration (singleton)
- `luma_events` - Synced Luma events
- `luma_guests` - Synced Luma guest lists
- `luma_sync_logs` - Sync operation history

## Authentication

- Public routes: `/`, `/register`, `/login`, `/admin-register`
- Protected routes: `/admin/*` (requires Supabase auth)
- Middleware handles session refresh and route protection
- Admin self-registration uses `ADMIN_REGISTRATION_SECRET` env var

## Environment Variables

Required:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `SUPABASE_SERVICE_ROLE_KEY`
- `ADMIN_REGISTRATION_SECRET`
- `NEXT_PUBLIC_APP_URL`

Note: Luma API key and Resend API key are stored in the database (`app_settings` table) and configured via the admin Settings page.

## Best Practices

1. Always use `createAdminClient()` for operations that modify data or need to bypass RLS
2. Validate all API inputs with Zod schemas
3. Handle errors gracefully and log to console
4. Use Server Components for data fetching when possible
5. Keep sensitive operations server-side only
6. Use toast notifications (sonner) for user feedback in admin UI
7. Follow existing component patterns in `src/components/admin/`

## Dynamic City Configuration

City name and timezone are stored in `app_settings` table:
- Fetch via `/api/settings/public` (public) or `/api/admin/settings` (authenticated)
- Display as "Cafe Cursor {city_name}" throughout the app
- Timezone used for date formatting

## API Keys Storage

API keys for external services are stored in the `app_settings` table (not environment variables):
- `luma_api_key` - For syncing guests from Luma events
- `resend_api_key` - For sending coupon emails

These are configured via the admin Settings page at `/admin/settings`. The public settings endpoint (`/api/settings/public`) only returns non-sensitive fields (city_name, timezone), while the authenticated admin endpoint returns all fields including API keys.

